C51 COMPILER V9.56.0.0   CALENDAR2                                                         03/11/2020 14:55:29 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE CALENDAR2
OBJECT MODULE PLACED IN calendar2.OBJ
COMPILER INVOKED BY: C:\Keil_v51\C51\BIN\C51.EXE calendar2.C OPTIMIZE(0,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          //************* calendar2.c *************************************
   2          //以Timer2計時中斷，進行萬年曆電子鐘顯示年、月、日、時、分、秒、星期
   3          //年、月、日、時、分、秒可自由設定，星期由程式判斷自行產生
   4          //作者:游景翔(青輔會青年職訓中心100期電子應用班)
   5          //*************************************************************
   6          #include "..\MPC82.H"   //暫存器及組態定義
   7          
   8                            //Fosc=22.1184MHz，Timer時脈=Fosc/12=1.8432MHz
   9          #define T  57600  //Timer延時時間=(1/1.8432MHz)*57600=31250uS
  10           unsigned char dly_sec=32; //設定計時重覆次數，時間=31250uS*32=1秒
  11           unsigned char sec=55; //設定秒初值 
  12          
  13          char code mes[]="\000\001\002";//0=年、1=月、2=日
  14          char code Table[]={
  15            0x10,0x1f,0x02,0x0f,0x0a,0xff,0x02,0x00, //年
  16            0x0f,0x09,0x0f,0x09,0x0f,0x09,0x13,0x00, //月
  17            0x0f,0x09,0x09,0x0f,0x09,0x09,0x0f,0x00};//日
  18          
  19          main()
  20          {
  21   1         int year=2009;      //設定年
  22   1         char mon=1,day=20;  //設定月、日
  23   1         char hor=13,min=32; //設定時、分值
  24   1         char i;           //變數宣告
  25   1         int y,m,d;      //陣列資料計數
  26   1         
  27   1         EA=1; ET2=1; //致能Timet2計時溢位中斷
  28   1         T2CON=0x00; //設定為內部計時，溢位重新載入
  29   1         RCAP2=T2R=65536-T; //設定Timer2及重新載入時間
  30   1         TR2=1;      //啟動Timet2
  31   1                      
  32   1         LCD_init();           //重置及清除LCD 
  33   1         for(i=0x0;i<=0x3f;i++) //寫入年月日字型 
  34   1         {
  35   2           LCD_Cmd(0x40+i);    //指定CGRAM位址  
  36   2           LCD_Data(Table[i]); //寫入CGRAM資料  
  37   2         } 
  38   1         while(1)   //開始顯示及計算萬年曆
  39   1         {  
  40   2          LCD_Cmd(0x80);  //顯示第一行位置
  41   2        LCD_Data(year/1000+'0');  //年的千位數到LCD顯示
  42   2        LCD_Data(year%1000/100+'0'); //年的百位數到LCD顯示
  43   2        LCD_Data(year%100/10+'0'); //年的十位數到LCD顯示
  44   2          LCD_Data(year%10+'0'); //年的個位數到LCD顯示
  45   2        LCD_Data(mes[0]); //顯示年
  46   2        LCD_Data(' ');  LCD_Data(' '); //空格
  47   2        
  48   2          LCD_Data(mon/10+'0'); //月的十位數到LCD顯示
  49   2          LCD_Data(mon%10+'0'); //月的個位數到LCD顯示
  50   2          LCD_Data(mes[1]); //顯示月
  51   2        LCD_Data(' ');  LCD_Data(' ');  //空格
  52   2      
  53   2          LCD_Data(day/10+'0'); //日的十位數到LCD顯示
  54   2          LCD_Data(day%10+'0'); //日的個位數到LCD顯示
  55   2        LCD_Data(mes[2]); //顯示日
C51 COMPILER V9.56.0.0   CALENDAR2                                                         03/11/2020 14:55:29 PAGE 2   

  56   2          
  57   2        LCD_Cmd(0xc0); //顯示第二行位置
  58   2        if(hor==12) //12時上午轉下午
  59   2         { LCD_Data('P'); LCD_Data('M'); LCD_Data(' ');} //顯示PM
  60   2        if(hor==24) //24時下午轉上午 
  61   2         { LCD_Data('A'); LCD_Data('M'); LCD_Data(' ');}//顯示AM
  62   2         
  63   2          if(hor<12) //時小於12
  64   2        { LCD_Data('A'); LCD_Data('M'); LCD_Data(' ');}  //顯示AM
  65   2          else if(hor>12 && hor<=23) //小時介於12-23之間
  66   2           { LCD_Data('P');  LCD_Data('M');  LCD_Data(' ');} //顯示PM
  67   2          
  68   2        if(hor<=12)   //時小於/等於12
  69   2          {
  70   3              LCD_Data(hor/10+'0');LCD_Data(hor%10+'0'); //顯示時
  71   3              LCD_Data(':');
  72   3             } 
  73   2           else    //時大於12
  74   2           {     
  75   3             LCD_Data((hor-12)/10+'0'); LCD_Data((hor-12)%10+'0');//顯示時
  76   3               LCD_Data(':');
  77   3            }
  78   2                
  79   2            LCD_Data(min/10+'0');LCD_Data(min%10+'0'); //顯示分
  80   2                LCD_Data(':');
  81   2          
  82   2                LCD_Data(sec/10+'0'); LCD_Data(sec%10+'0');//顯示秒
  83   2                LCD_Data(' ');
  84   2      
  85   2        if(year%4==0) //閏年
  86   2        {
  87   3          y=((year-1)+(year-1)/4-(year-1)/100+(year-1)/400); 
  88   3          switch (mon)   //逢4年閏年,逢百不閏,逢400年閏年
  89   3          {
  90   4            case 1:  m=day; break;       //1月
  91   4            case 2:  m=(day+31); break;  //2月
  92   4            case 3:  m=(day+60); break;  //3月
  93   4            case 4:  m=(day+91); break;  //4月
  94   4            case 5:  m=(day+121); break; //5月
  95   4            case 6:  m=(day+152); break; //6月
  96   4            case 7:  m=(day+182); break; //7月
  97   4            case 8:  m=(day+213); break; //8月
  98   4            case 9:  m=(day+244); break; //9月
  99   4            case 10: m=(day+274); break; //10月
 100   4            case 11: m=(day+305); break; //11月
 101   4            case 12: m=(day+335); break; //12月
 102   4            }
 103   3         }
 104   2        else if(year%4==1||2||3)  //非閏年
 105   2         {
 106   3          y=((year-1)+(year-1)/4-(year-1)/100+(year-1)/400);
 107   3          switch (mon)
 108   3          {
 109   4            case 1:  m=day;       break; //1月
 110   4            case 2:  m=(day+31);  break; //2月
 111   4            case 3:  m=(day+59);  break; //3月
 112   4            case 4:  m=(day+90);  break; //4月
 113   4            case 5:  m=(day+120); break; //5月
 114   4            case 6:  m=(day+151); break; //6月
 115   4            case 7:  m=(day+187); break; //7月
 116   4            case 8:  m=(day+212); break; //8月
 117   4            case 9:  m=(day+243); break; //9月
C51 COMPILER V9.56.0.0   CALENDAR2                                                         03/11/2020 14:55:29 PAGE 3   

 118   4            case 10: m=(day+273); break; //10月
 119   4            case 11: m=(day+304); break; //11月
 120   4            case 12: m=(day+334); break; //12月
 121   4          }
 122   3        }
 123   2        d=(y+m)%7;  //總天數除以7的餘數
 124   2        if(d==1) //星期一
 125   2          { LCD_Data('M');LCD_Data('o');LCD_Data('n');} //顯示Mon
 126   2        
 127   2        if(d==2) //星期二
 128   2          { LCD_Data('T');LCD_Data('u');LCD_Data('e');} //顯示Tue
 129   2        
 130   2        if(d==3) //星期三
 131   2          { LCD_Data('W');LCD_Data('e');LCD_Data('d');} //顯示Wed
 132   2        
 133   2        if(d==4) //星期四
 134   2          { LCD_Data('T');LCD_Data('h');LCD_Data('u');} //顯示Thu
 135   2        
 136   2        if(d==5) //星期五
 137   2          { LCD_Data('F');LCD_Data('r');LCD_Data('i');} //顯示Fri
 138   2        
 139   2        if(d==6)  //星期六
 140   2          { LCD_Data('S');LCD_Data('a');LCD_Data('t');} //顯示Sat
 141   2        
 142   2        if(d==0)  //星期日
 143   2          { LCD_Data('S');LCD_Data('u');LCD_Data('n');} //顯示Sun
 144   2      
 145   2          if (sec < 60) continue; //若秒小於60到while(1)處   
 146   2          sec=0; min++;           //秒等於60則令秒=0，分加一
 147   2          if (min < 60) continue; //若分小於60到while(1)處   
 148   2          min=0; hor++;           //若分等於60則令分=0，時加一
 149   2        if(hor==24) 
 150   2         {
 151   3          switch (day)  //檢查日
 152   3           {
 153   4            case 28:   //日=28
 154   4           if(year%4==0 && mon==2) day++;//29天//閏年2月
 155   4            else if(mon==2) { day=0; mon++;}//28天
 156   4                  else day++;  break;
 157   4          
 158   4          case 29: //日=29
 159   4            if(year%4==0 && mon==2) { day=0;mon++; }
 160   4              else day++;  break;
 161   4          
 162   4          case 30: //日=30
 163   4            if(mon==4 || mon==6 || mon==9 || mon==11) 
 164   4            {day=0;mon++;}  //4.6.9.11月30天
 165   4              else day++; break;
 166   4            
 167   4          case 31: //日=31
 168   4            if(mon==1||mon==3||mon==5||mon==7||mon==8||mon==10) 
 169   4            { day=0;mon++; }   //1.3.5.7.8.10月31天
 170   4               else if(mon==12)
 171   4              { day=0; mon=1;year++;}  //過年
 172   4            break;
 173   4           }
 174   3          if(day<28) day++; //日<28
 175   3         }
 176   2          if (hor <25)  continue; //若時小於24到while(1)處
 177   2          hor=1;min=0; sec=0;//若時等於24則令時、分、秒=0 
 178   2        }
 179   1      }
C51 COMPILER V9.56.0.0   CALENDAR2                                                         03/11/2020 14:55:29 PAGE 4   

 180          /*******************************************************/ 
 181          void T2_int(void) interrupt 5  //Timer2中斷函數
 182          {
 183   1        dly_sec--;          //計時重覆次數遞減
 184   1        if(dly_sec==0)        //若秒時間到
 185   1         { sec++; dly_sec=32;}//秒遞加及重覆次數(設中斷點)
 186   1        TF2=0;                //清除計時溢位TF2=0
 187   1      }
 188          /***********************************************************
 189          *函數名稱: LCD_Data
 190          *功能描述: 傳送資料到文字型LCD
 191          *輸入參數：dat
 192          ************************************************************/
 193          void LCD_Data(char dat)  //傳送資料到LCD
 194          {
 195   1          Data=dat; //資料送到BUS
 196   1          RS=1;RW=0;EN=1;//資料寫入到LCD內
 197   1          Delay_ms(1);   //LCD等待寫入完成
 198   1          EN=0;          //禁能LCD    
 199   1      }
 200          /***************************************************************
 201          *函數名稱: LCD_Cmd
 202          *功能描述: 傳送命令到文字型LCD
 203          *輸入參數：Cmd
 204          ************************************************************/
 205          void LCD_Cmd(unsigned char Cmd) //傳送命令到LCD
 206          {
 207   1          Data=Cmd;  //命令送到BUS
 208   1          RS=0;RW=0;EN=1; //命令寫入到LCD內
 209   1          Delay_ms(1);    //LCD等待寫入完成     
 210   1          EN=0;           //禁能LCD
 211   1      }
 212          /***************************************************************
 213          *函數名稱: LCD_init
 214          *功能描述: 啟始化文字型LCD
 215          *****************************************************************/
 216          void LCD_init(void)    //LCD的啟始程式  
 217          {
 218   1          LCD_Cmd(0x38);/*0011 1000,8bit傳輸,顯示2行,5*7字型
 219   1                          bit4:DL=1,8bit傳輸,
 220   1                          bit3:N=1,顯示2行
 221   1                          bit2:F=0,5*7字型*/    
 222   1          LCD_Cmd(0x0c);/*0000 1100,顯示幕ON,不顯示游標,游標不閃爍
 223   1                          bit2:D=1,顯示幕ON
 224   1                          bit1:C=0,不顯示游標
 225   1                        bit0:B=0,游標不閃爍*/
 226   1          LCD_Cmd(0x06);/*0000 0110,//顯示完游標右移,游標移位禁能 
 227   1                          bit1:I/D=1,顯示完游標右移,
 228   1                          bit0:S=0,游標移位禁能*/  
 229   1          LCD_Cmd(0x01); //清除顯示幕  
 230   1          LCD_Cmd(0x02); //游標回原位  
 231   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1908    ----
   CONSTANT SIZE    =     28    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.56.0.0   CALENDAR2                                                         03/11/2020 14:55:29 PAGE 5   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
